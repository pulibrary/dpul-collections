name: dpul-collections
services:
  database:
    type: postgres:15
    portforward: 5434
  figgy_database:
    type: postgres:15
    portforward: 5435
  test_solr:
    type: lando
    build_as_root:
      - apt-get update -y && apt-get install -y zip
    healthcheck: "curl http://solr:SolrRocks@localhost:8983/solr/admin/info/health"
    run:
      - /app/bin/setup_solr.sh
    services:
      image: pulibrary/ci-solr:8.4-v1.0.0
      ports:
        - "8984:8983"
      command: bin/solr -cloud -noprompt -f -p 8983
  development_solr:
    type: lando
    build_as_root:
      - apt-get update -y && apt-get install -y zip
    healthcheck: "curl http://solr:SolrRocks@localhost:8983/solr/admin/info/health"
    run:
      - /app/bin/setup_solr.sh
    services:
      image: pulibrary/ci-solr:8.4-v1.0.0
      ports:
        - "8985:8983"
      command: bin/solr -cloud -noprompt -f -p 8983
  embedding_server:
    type: lando
    app_mount: false
    services:
      image: ollama/ollama:latest
      ports:
        - "11439:11434"
      command: 
        - "/bin/sh"
        - "-c"
        - "ollama serve & until ollama list >/dev/null 2>&1; do sleep 1; done; ollama pull hf.co/Qwen/Qwen3-Embedding-0.6B-GGUF:f16; wait"
      environment:
        OLLAMA_KEEP_ALIVE: -1
    overrides:
      shm_size: '12gb'
      volumes:
        - tmp/ollama:/root/.ollama
